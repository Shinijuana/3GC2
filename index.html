<!doctype html>
<html>
  <head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, user-scalable=no'>
    <meta name='mobile-web-app-capable' content='yes'>
    <meta name='apple-mobile-web-app-capable' content='yes'>
    <link rel='icon' type='image/png' sizes='32x32' href='favicon-32x32.png'>
    <link rel='stylesheet' href='css/common.css'>
    
    <title>Immersive AR Session</title>
</head>
  <body>
    <header>
      <details open>
        <summary>Immersive AR Session</summary>
        <p>
          This sample demonstrates how to use an 'immersive-ar' XRSession to
          present a simple WebGL scene to a transparent or passthrough XR
          device. The logic is largely the same as the corresponding VR sample,
          with the primary difference being that no background is rendered and
          the model is scaled down for easier viewing in a real-world space.
          <a class="back" href="./">Back</a>
        </p>
      </details>
    </header>
    <!-- Importa Three.js e GLTFLoader -->
    <script type="module">
      import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.module.js';
      import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/loaders/GLTFLoader.js';

      // Altre importazioni
      import { WebXRButton } from './js/util/webxr-button.js';
      import { Scene } from './js/render/scenes/scene.js';
      import { Renderer, createWebGLContext } from './js/render/core/renderer.js';
      import { QueryArgs } from './js/util/query-args.js';
      import WebXRPolyfill from './js/third-party/webxr-polyfill/build/webxr-polyfill.module.js';

      // Polyfill support for non WebXR devices
      if (QueryArgs.getBool('usePolyfill', true)) {
        let polyfill = new WebXRPolyfill();
      }

      // XR globals
      let xrButton = null;
      let xrImmersiveRefSpace = null;

      // WebGL scene globals
      let gl = null;
      let renderer = null;
      let scene = new Scene();

      // Setup Three.js
      const threeScene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      const threeRenderer = new THREE.WebGLRenderer({ alpha: true });
      threeRenderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(threeRenderer.domElement);

      // Load the GLB model using Three.js
      const loader = new GLTFLoader();
      loader.load('./assets/full.glb', (gltf) => {
        // Set the scale and position of the model
        gltf.scene.scale.set(10, 10, 10);
        gltf.scene.position.set(0, 0, -2);
        threeScene.add(gltf.scene);
        console.log('GLTF model loaded and added to Three.js scene:', gltf);
      }, undefined, (error) => {
        console.error('Error loading GLTF model:', error);
      });

      // Initialize WebXR session
      function initXR() {
        xrButton = new WebXRButton({
          onRequestSession: onRequestSession,
          onEndSession: onEndSession,
          textEnterXRTitle: "START AR",
          textXRNotFoundTitle: "AR NOT FOUND",
          textExitXRTitle: "EXIT AR",
        });
        document.querySelector('header').appendChild(xrButton.domElement);

        if (navigator.xr) {
          navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            xrButton.enabled = supported;
            console.log("AR supported:", supported);
          });

          navigator.xr.requestSession('inline').then(onSessionStarted);
        }
      }

      function onRequestSession() {
        return navigator.xr.requestSession('immersive-ar')
            .then((session) => {
              xrButton.setSession(session);
              session.isImmersive = true;
              console.log("Immersive AR session started");
              onSessionStarted(session);
            });
      }

      function initGL() {
        if (gl)
          return;

        // Create WebGL context with transparent background for AR passthrough
        gl = createWebGLContext({
          xrCompatible: true,
          alpha: true,
          premultipliedAlpha: false
        });
        document.body.appendChild(gl.canvas);

        function onResize() {
          gl.canvas.width = gl.canvas.clientWidth * window.devicePixelRatio;
          gl.canvas.height = gl.canvas.clientHeight * window.devicePixelRatio;
          threeRenderer.setSize(window.innerWidth, window.innerHeight); // Resize Three.js renderer
        }
        window.addEventListener('resize', onResize);
        onResize();

        renderer = new Renderer(gl);
        scene.setRenderer(renderer);

        // Log that the WebGL context and renderer are initialized
        console.log("WebGL context initialized");
      }

      function onSessionStarted(session) {
        session.addEventListener('end', onSessionEnded);

        initGL();

        session.updateRenderState({ baseLayer: new XRWebGLLayer(session, gl) });

        let refSpaceType = session.isImmersive ? 'local' : 'viewer';
        session.requestReferenceSpace(refSpaceType).then((refSpace) => {
          xrImmersiveRefSpace = refSpace;
          console.log("Reference space obtained:", refSpaceType);
          session.requestAnimationFrame(onXRFrame);
        });
      }

      function onEndSession(session) {
        session.end();
        console.log("AR session ended");
      }

      function onSessionEnded(event) {
        xrButton.setSession(null);
        console.log("Session ended, switching back to inline view if applicable");
      }

      // Called every time a XRSession requests that a new frame be drawn
      function onXRFrame(t, frame) {
        let session = frame.session;
        let refSpace = xrImmersiveRefSpace;
        let pose = frame.getViewerPose(refSpace);

        // Log the pose of the viewer
        if (pose) {
          console.log("Viewer pose obtained");
        } else {
          console.log("No viewer pose available");
        }

        scene.startFrame();
        session.requestAnimationFrame(onXRFrame);

        if (pose) {
          // Update Three.js camera
          camera.position.copy(pose.transform.position);
          camera.rotation.copy(pose.transform.orientation);

          // Render the Three.js scene
          threeRenderer.render(threeScene, camera);
          console.log("Frame drawn successfully");
        } else {
          console.error("Pose is not available; unable to draw frame");
        }

        scene.endFrame();
      }

      // Start the XR application
      initXR();
    </script>
  
  </body>
</html>
